# Dokumentasi Sistem Unit & Tour - Jakhabitat

## Overview
Sistem manajemen panorama 360° untuk unit hunian dengan fitur upload, preview, dan integrasi dengan master data unit.

## Fitur Utama

### 1. Upload Panorama 360°
- **Pilihan Unit**: Dropdown dengan detail lengkap unit (nama, tipe, kategori, luas, lokasi)
- **Preview Unit**: Menampilkan informasi unit yang dipilih sebelum upload
- **Format File**: Mendukung PNG, JPG, JPEG hingga 10MB
- **Multiple Upload**: Bisa upload beberapa file sekaligus

### 2. Manajemen Records
- **Tabel Panorama**: Menampilkan semua panorama yang telah diupload
- **Detail Unit**: Nama unit, tipe, luas, lokasi dalam satu kolom
- **Info File**: Filename, ukuran file, tanggal upload
- **Actions**: Tombol Detail dan Hapus

### 3. Preview & Detail
- **Modal Detail**: Preview gambar panorama dalam modal
- **Info Lengkap**: Detail unit dan informasi file
- **Image Loading**: Fallback jika gambar tidak ditemukan

## Struktur Database

### Tabel: WEBSITE_JAKHABITAT_FOTO
```sql
CREATE TABLE WEBSITE_JAKHABITAT_FOTO (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  FILENAME VARCHAR2(255) NOT NULL,
  ORIGINAL_NAME VARCHAR2(255) NOT NULL,
  FILE_PATH VARCHAR2(500) NOT NULL,
  FILE_SIZE NUMBER,
  MIME_TYPE VARCHAR2(100),
  CATEGORY VARCHAR2(50) DEFAULT 'panorama',
  UNIT_ID NUMBER,
  CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Relasi dengan Master Unit
- **Foreign Key**: UNIT_ID → WEBSITE_JAKHABITAT_MASTER_UNIT.ID
- **Join Query**: Mengambil nama unit, tipe, luas, lokasi

## Struktur File System

### Direktori Penyimpanan
```
/home/wasilah/migration/images/jakhabitat/360/
├── 2024/
│   ├── 12/
│   │   ├── 27/
│   │   │   ├── panorama-1758023648522-564965877.png
│   │   │   └── panorama-1758024123456-789012345.jpg
│   │   └── 28/
│   └── 11/
└── 2025/
```

### Format Filename
- **Pattern**: `panorama-{timestamp}-{random}.{ext}`
- **Contoh**: `panorama-1758023648522-564965877.png`
- **Ekstensi**: Sesuai file asli (.png, .jpg, .jpeg)

## API Endpoints

### 1. Upload Panorama
```http
POST /api/jakhabitat/upload/panorama
Authorization: Bearer {token}
Content-Type: multipart/form-data

Body:
- panorama: File
- unitId: Number
```

### 2. Get Panoramas
```http
GET /api/jakhabitat/panoramas
Authorization: Bearer {token}

Response:
{
  "success": true,
  "photos": [
    {
      "id": 1,
      "filename": "panorama-1758023648522-564965877.png",
      "originalName": "kamar_tidur.png",
      "fileSize": 2048576,
      "unitId": 1,
      "unitName": "Tower Kanaya",
      "tipeUnit": "1 BR",
      "luas": 45,
      "lokasi": "Jakarta Barat",
      "createdAt": "2024-12-27T10:30:00Z"
    }
  ]
}
```

### 3. Serve Image
```http
GET /api/jakhabitat/image/{filename}

Response: Image file atau 404 Not Found
```

### 4. Delete Panorama
```http
DELETE /api/jakhabitat/panoramas/{id}
Authorization: Bearer {token}
```

## Komponen Frontend

### 1. UnitTourManager.tsx
- **Location**: `/src/components/cms/UnitTourManager.tsx`
- **Props**: `{ authState, units }`
- **State Management**: 
  - `selectedUnit`: Unit yang dipilih
  - `panoramas`: List panorama
  - `showDetailModal`: Status modal
  - `selectedPanorama`: Panorama untuk detail

### 2. Integrasi dengan CMS
- **Parent**: CMSDashboard.tsx
- **Menu**: Konten → Unit & Tour
- **Authentication**: Menggunakan useAuth hook

## Konfigurasi Server

### 1. Backend Server (Port 6000)
```javascript
// Static file serving
app.use('/images', express.static('/home/wasilah/migration/images/jakhabitat'));

// Upload configuration
const storage = multer.diskStorage({
  destination: '/home/wasilah/migration/images/jakhabitat/360/{year}/{month}/{date}',
  filename: 'panorama-{timestamp}-{random}.{ext}'
});
```

### 2. Frontend Proxy (Development)
```javascript
// vite.config.ts
server: {
  proxy: {
    '/images': {
      target: 'http://127.0.0.1:6000',
      changeOrigin: true
    }
  }
}
```

### 3. Production URLs
- **API**: `https://dprkp.jakarta.go.id/api/jakhabitat/`
- **Images**: `https://dprkp.jakarta.go.id/api/jakhabitat/image/{filename}`

## Keamanan & Validasi

### 1. Authentication
- **Bearer Token**: Semua endpoint memerlukan token
- **Session Storage**: Token disimpan di browser
- **Auto Refresh**: Token refresh otomatis

### 2. File Validation
- **MIME Type**: Hanya image files
- **File Size**: Maksimal 10MB
- **Extension**: .png, .jpg, .jpeg

### 3. Error Handling
- **Upload Errors**: Alert dengan pesan error
- **Image Loading**: Fallback SVG placeholder
- **API Errors**: Console logging dan user notification

## Troubleshooting

### 1. Gambar Tidak Tampil
- Cek path file di database
- Pastikan direktori exists
- Verify API endpoint response

### 2. Upload Gagal
- Cek ukuran file (max 10MB)
- Pastikan format file didukung
- Verify authentication token

### 3. Unit Tidak Muncul
- Cek koneksi ke master-unit API
- Verify database master unit
- Check authentication

## Pengembangan Selanjutnya

### 1. Fitur Tambahan
- [ ] Bulk upload panorama
- [ ] Image compression
- [ ] Thumbnail generation
- [ ] Search & filter panorama

### 2. Optimisasi
- [ ] Lazy loading images
- [ ] CDN integration
- [ ] Image caching
- [ ] Progressive loading

### 3. Integrasi
- [ ] 360° viewer integration
- [ ] Virtual tour builder
- [ ] Social media sharing
- [ ] Export functionality

## Maintenance

### 1. Database Cleanup
```sql
-- Hapus orphaned records
DELETE FROM WEBSITE_JAKHABITAT_FOTO 
WHERE UNIT_ID NOT IN (SELECT ID FROM WEBSITE_JAKHABITAT_MASTER_UNIT);
```

### 2. File System Cleanup
```bash
# Hapus file yang tidak ada di database
find /home/wasilah/migration/images/jakhabitat/360/ -name "*.png" -o -name "*.jpg" | while read file; do
  filename=$(basename "$file")
  # Check if exists in database
done
```

### 3. Monitoring
- Monitor disk usage di `/home/wasilah/migration/images/`
- Log API response times
- Track upload success/failure rates

---

**Dibuat**: 27 Desember 2024  
**Versi**: 1.0  
**Author**: Amazon Q Developer